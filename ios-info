from netmiko import ConnectHandler
from netmiko.exceptions import NetMikoTimeoutException
from netmiko.exceptions import SSHException
from netmiko.exceptions import AuthenticationException

import re
import time

#here is list of cisco routers ip addresses
def read_ip_list(file_path):
    with open(file_path, 'r') as file:
        ip_list = [line.strip() for line in file if line.strip()]
    return ip_list

ip_list = read_ip_list('ip_list.txt')

#list where informations will be stored
devices = []

#clearing the old data from the CSV file and writing the headers
print(f"Create file IOS.csv")
f = open("IOS.csv", "w+")
f.write("IP Address;Hostname;Uptime;Current_Version;Current_Image;Serial_Number;Device_Model;Device_Memory")
f.write("\n")
f.close()

#clearing the old data from the CSV file and writing the headers
print(f"login_issues.csv")
f = open("login_issues.csv", "w+")
f.write("IP Address;Status")
f.write("\n")
f.close()



#loop all ip addresses in ip_list
for ip in ip_list:
    cisco = {
    'device_type':'autodetect',
    'ip':ip,
    'username':'cisco',     #ssh username
    'password':'cisco',  #ssh password
    'ssh_strict':False,  
    'fast_cli':False,
    }
    
    #handling exceptions errors
    
    try:
        net_connect = ConnectHandler(**cisco)
    except NetMikoTimeoutException:
        f = open("login_issues.csv", "a")
        f.write(ip + ";" + "Device Unreachable/SSH not enabled")
        f.write("\n")
        f.close()
        continue
    except AuthenticationException:
        f = open("login_issues.csv", "a")
        f.write(ip + ";" + "Authentication Failure")
        f.write("\n")
        f.close()
        continue
    except SSHException:
        f = open("login_issues.csv", "a")
        f.write(ip + ";" + "SSH not enabled")
        f.write("\n")
        f.close()
        continue

    try:
        net_connect.enable()

    #handling exceptions errors        
    except ValueError:
        f = open("login_issues.csv", "a")
        f.write(ip + ";" + "Could be SSH Enable Password issue")
        f.write("\n")
        f.close()
        continue
    
    print(f"Connected to {ip}. Reading data...")

    for line in output_lines:
        if ' uptime is ' in line:
            hostname = line.split(' ')[0]
            uptime = line.split(' uptime is ')[1]
        if 'Cisco IOS Software' in line:
            version = line.split('Version ')[1].split(',')[0]
        if 'Processor board ID' in line:
            serial = line.split(' ')[-1]
        if 'System image file is' in line:
            ios = line.split('"')[1]
        if line.lower().startswith('cisco') and 'memory' in line:
            model = line.split(' ')[1]
        if 'with' in line and 'bytes of memory' in line:
            memory = line.split('with ')[1].split(' bytes')[0]
    
    
    #append results to table [hostname,uptime,version,serial,ios,model]
    devices.append([ip, hostname, uptime, version, ios, serial, model, memory])

    print(f"Data read form {ip}. Disconnecting...")
    net_connect.disconnect()
    


#print all results (for all routers) on screen    
with open ("IOS.csv", "a") as f:
    for device in devices:
        f.write(";".join(device) + "\n")

print(f"All connections closed and data saved")
